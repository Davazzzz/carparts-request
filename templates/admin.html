<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Parts Requests</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f7;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            text-align: center;
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 12px 24px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .delete-all-btn {
            padding: 12px 24px;
            border: 2px solid #e74c3c;
            background: white;
            color: #e74c3c;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-left: auto;
        }

        .delete-all-btn:hover {
            background: #e74c3c;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .requests-container {
            display: grid;
            gap: 20px;
        }

        .request-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
        }

        .request-card.new {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .request-card.quoted {
            border-left-color: #ffc107;
            background: #fffbf0;
        }

        .request-card.completed {
            border-left-color: #6c757d;
            background: #f8f9fa;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .request-id {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .status-new {
            background: #28a745;
            color: white;
        }

        .status-quoted {
            background: #ffc107;
            color: #333;
        }

        .status-completed {
            background: #6c757d;
            color: white;
        }

        .request-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1em;
            color: #333;
            font-weight: 500;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .btn-quote {
            background: #667eea;
            color: white;
        }

        .btn-complete {
            background: #28a745;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn-submit {
            flex: 1;
            background: #667eea;
            color: white;
            padding: 15px;
            font-size: 1.1em;
        }

        .btn-cancel {
            flex: 1;
            background: #6c757d;
            color: white;
            padding: 15px;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .stats {
                grid-template-columns: 1fr 1fr;
            }

            .request-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèÉ Junkyard Runner - Admin Panel</h1>
        <p>Manage customer requests and send quotes</p>
    </div>

    <div class="stats" id="stats">
        <div class="stat-card">
            <div class="stat-number" id="stat-total">0</div>
            <div class="stat-label">Total Requests</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="stat-new">0</div>
            <div class="stat-label">New</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="stat-quoted">0</div>
            <div class="stat-label">Quoted</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="stat-completed">0</div>
            <div class="stat-label">Completed</div>
        </div>
    </div>

    <div class="filters">
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterRequests('all')">All</button>
            <button class="filter-btn" onclick="filterRequests('new')">New</button>
            <button class="filter-btn" onclick="filterRequests('quoted')">Quoted</button>
            <button class="filter-btn" onclick="filterRequests('completed')">Completed</button>
            <button class="delete-all-btn" onclick="deleteAllRequests()">üóëÔ∏è Delete All</button>
        </div>
    </div>

    <div class="requests-container" id="requests-container">
        <p style="text-align: center; padding: 40px; color: #999;">Loading requests...</p>
    </div>

    <!-- Pricing Calculator Modal -->
    <div class="modal" id="quoteModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üí∞ Pricing Calculator</h2>
                <p style="color: #666; font-size: 0.9em;">Total = Part Price (includes tax) + 30% Warranty + $3 Yard Entry + Labor + Travel + Delivery ($2/mile)</p>
            </div>

            <!-- Junkyard Part Search -->
            <div class="form-group">
                <label>üîç Search Junkyard Part (Optional - auto-fills price with tax)</label>
                <input type="text" id="part_search" placeholder="Type part name (e.g., 'bumper', 'headlight')" oninput="searchJunkyardPart()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                <div id="part_search_results" style="display: none; max-height: 200px; overflow-y: auto; border: 2px solid #667eea; border-radius: 8px; margin-top: 10px; background: white;"></div>
            </div>

            <div class="form-group">
                <label>Part Price from Junkyard (with tax) ($)</label>
                <input type="number" id="part_price" step="0.01" min="0" value="0" oninput="calculateTotal()">
            </div>

            <div class="form-group">
                <label>Yard Entry Fee ($) - Fixed</label>
                <input type="number" id="yard_entry" step="0.01" min="0" value="3" readonly style="background: #f5f5f5; cursor: not-allowed;">
            </div>

            <div class="form-group">
                <label>Labor Fee ($)</label>
                <select id="labor_fee_select" onchange="handleLaborFeeChange()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                    <option value="25">$25</option>
                    <option value="30">$30</option>
                    <option value="35">$35</option>
                    <option value="40">$40</option>
                    <option value="45">$45</option>
                    <option value="50">$50</option>
                    <option value="55">$55</option>
                    <option value="60">$60</option>
                    <option value="65">$65</option>
                    <option value="70">$70</option>
                    <option value="75">$75</option>
                    <option value="80">$80</option>
                    <option value="85">$85</option>
                    <option value="90">$90</option>
                    <option value="95">$95</option>
                    <option value="100">$100</option>
                </select>
            </div>

            <div class="form-group">
                <label>Travel Fee ($)</label>
                <select id="travel_fee_select" onchange="handleTravelFeeChange()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                    <option value="10">$10</option>
                    <option value="15">$15</option>
                    <option value="20">$20</option>
                </select>
            </div>

            <div class="form-group">
                <label>Delivery (Miles - $2 per mile, or $0 for pickup)</label>
                <input type="number" id="delivery_miles" step="0.1" min="0" value="0" placeholder="0 = Pickup Only" oninput="calculateTotal()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                <small style="color: #666; display: block; margin-top: 5px;">Delivery Fee: $<span id="delivery_fee_display">0.00</span> (<span id="delivery_miles_display">0</span> miles √ó $2/mile)</small>
            </div>

            <div class="form-group">
                <label>90-Day Warranty (30% of Part Price)</label>
                <select id="warranty_fee_select" onchange="handleWarrantyFeeChange()" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                    <option value="0">No Warranty ($0)</option>
                    <option value="30percent">Yes - Add 30% (90 days from junkyard purchase)</option>
                </select>
                <small style="color: #666; display: block; margin-top: 5px;">
                    Customer selected warranty: <span id="warranty_selected">No</span><br>
                    <span id="warranty_fee_display" style="font-weight: bold; color: #28a745;"></span>
                </small>
            </div>

            <div class="form-group" style="background: #f0f4ff; padding: 20px; border-radius: 8px; border: 3px solid #667eea; margin-top: 20px;">
                <label style="font-size: 1.4em; color: #667eea; font-weight: bold;">TOTAL QUOTE ($)</label>
                <input type="number" id="quote_amount" step="0.01" min="0" readonly style="font-size: 1.6em; font-weight: bold; color: #667eea; background: white;">
            </div>

            <div class="form-group">
                <label>Deposit Amount ($)</label>
                <input type="number" id="deposit_amount" step="0.01" min="0" required>
            </div>

            <div class="form-group">
                <label>Message to Customer</label>
                <textarea id="quote_message" placeholder="Include details about the part, condition, availability, etc."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-submit" onclick="submitQuote()">Send Quote</button>
                <button class="btn btn-cancel" onclick="closeQuoteModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let allRequests = [];
        let currentFilter = 'all';
        let currentRequestId = null;

        // Load requests on page load
        loadRequests();

        async function loadRequests() {
            try {
                const response = await fetch('/admin/requests');
                const data = await response.json();

                if (data.success) {
                    allRequests = data.requests;
                    updateStats(data.stats);
                    displayRequests();
                }
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

        function updateStats(stats) {
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-new').textContent = stats.new;
            document.getElementById('stat-quoted').textContent = stats.quoted;
            document.getElementById('stat-completed').textContent = stats.completed;
        }

        function filterRequests(status) {
            currentFilter = status;

            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            displayRequests();
        }

        function displayRequests() {
            const container = document.getElementById('requests-container');

            // Filter requests
            let filteredRequests = allRequests;
            if (currentFilter !== 'all') {
                filteredRequests = allRequests.filter(r => r.status === currentFilter);
            }

            if (filteredRequests.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No requests found.</p>';
                return;
            }

            container.innerHTML = filteredRequests.map(req => `
                <div class="request-card ${req.status}">
                    <div class="request-header">
                        <div class="request-id">Request #${req.id}</div>
                        <div class="status-badge status-${req.status}">${req.status}</div>
                    </div>

                    <div class="request-info">
                        <div class="info-group">
                            <div class="info-label">Customer</div>
                            <div class="info-value">${req.customer_name}</div>
                            <a href="sms:${req.customer_phone}" style="text-decoration: none;">
                                <div class="info-value" style="font-size: 0.9em; color: #2196f3; cursor: pointer; font-weight: 600;">
                                    üì± ${req.customer_phone}
                                </div>
                            </a>
                            ${req.customer_email ? `<div class="info-value" style="font-size: 0.9em; color: #666;">${req.customer_email}</div>` : ''}
                        </div>

                        <div class="info-group">
                            <div class="info-label">Vehicle</div>
                            <div class="info-value">${req.vehicle_year} ${req.vehicle_make} ${req.vehicle_model}</div>
                            ${req.vehicle_color ? `<div class="info-value" style="font-size: 0.9em; color: #666;">Color: ${req.vehicle_color}</div>` : ''}
                            ${req.color_doesnt_matter ? `<div class="info-value" style="font-size: 0.9em; color: #28a745; font-weight: bold;">‚úì Color doesn't matter</div>` : ''}
                            ${req.mileage > 0 ? `<div class="info-value" style="font-size: 0.9em; color: #666;">Mileage: ${req.mileage} miles</div>` : ''}
                        </div>

                        ${req.secure_method ? `
                        <div class="info-group">
                            <div class="info-label">üîí Way to Secure Part</div>
                            <div class="info-value">
                                ${req.secure_method === 'warranty' ? 'Option 1 - WARRANTY PURCHASE (recommended)' :
                                  req.secure_method === 'live_confirmation' ? 'Option 2 - LIVE CONFIRMATION (fast response)' :
                                  req.secure_method === 'deposit' ? 'Option 3 - DEPOSIT HOLD (longer wait)' : req.secure_method}
                            </div>
                            <div class="info-value" style="margin-top: 8px;">
                                <strong>Warranty:</strong> <span style="font-size: 1.3em;">${req.warranty ? '‚úÖ' : '‚ùå'}</span>
                            </div>
                        </div>
                        ` : ''}

                        ${req.compatible_models ? `
                        <div class="info-group" style="background: #e8f5e9;">
                            <div class="info-label">‚ö° Compatible Models</div>
                            <div class="info-value" style="color: #2e7d32;">${req.compatible_models}</div>
                        </div>
                        ` : ''}

                        ${req.pyp_location ? `
                        <div class="info-group" style="background: #fff3e0;">
                            <div class="info-label">üìç PYP Location</div>
                            <div class="info-value" style="color: #e65100;">${req.pyp_location}</div>
                        </div>
                        ` : ''}

                        <div class="info-group">
                            <div class="info-label">Date & Time</div>
                            <div class="info-value">${req.date}</div>
                            <div class="info-value" style="font-size: 0.9em; color: #666;">${req.time}</div>
                        </div>
                    </div>

                    <!-- CONSOLIDATED PARTS NEEDED SECTION -->
                    <div class="info-group" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px;">
                        <div class="info-label" style="color: white; font-size: 1.2em; margin-bottom: 15px;">
                            üîß PARTS NEEDED - FULL DETAILS
                        </div>

                        ${req.part_needed ? `
                            <div style="background: rgba(255,255,255,0.95); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #f44336;">
                                <div style="color: #c62828; font-weight: bold; margin-bottom: 5px;">üìù Option 1 - Part Name/s:</div>
                                <div style="color: #333; font-size: 1.05em;">${req.part_needed}</div>
                            </div>
                        ` : ''}

                        ${req.junkyard_parts && req.junkyard_parts !== '[]' && req.junkyard_parts !== '' ? `
                            <div style="background: rgba(255,255,255,0.95); padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #ff9800;">
                                <div style="color: #f57c00; font-weight: bold; margin-bottom: 8px;">üí∞ Option 2 - Junkyard Parts Selected:</div>
                                ${(() => {
                                    try {
                                        const parts = typeof req.junkyard_parts === 'string' ? JSON.parse(req.junkyard_parts) : req.junkyard_parts;
                                        if (Array.isArray(parts) && parts.length > 0) {
                                            const partsList = parts.map(p => `<div style="color: #333; margin: 5px 0; padding: 6px; background: #fff3e0; border-radius: 4px;"><strong>${p.name}</strong>: $${p.price.toFixed(2)} ${p.qty > 1 ? `(x${p.qty} = $${(p.price * p.qty).toFixed(2)})` : ''}</div>`).join('');
                                            const totalCost = parts.reduce((sum, p) => sum + (p.price * p.qty), 0);
                                            const tax = totalCost * 0.0975;
                                            const totalWithTax = totalCost + tax;
                                            return partsList + `<div style="margin-top: 8px; padding: 8px; background: #4caf50; color: white; border-radius: 4px; font-weight: bold; font-size: 0.95em;">Subtotal: $${totalCost.toFixed(2)} | Tax (9.75%): $${tax.toFixed(2)} | Total: $${totalWithTax.toFixed(2)}</div>`;
                                        }
                                        return '<div style="color: #666;">No parts data</div>';
                                    } catch (e) {
                                        return '<div style="color: #666;">' + req.junkyard_parts + '</div>';
                                    }
                                })()}
                            </div>
                        ` : ''}

                        ${req.additional_notes ? `
                            <div style="background: rgba(255,255,255,0.95); padding: 12px; border-radius: 8px; border-left: 4px solid #9e9e9e;">
                                <div style="color: #424242; font-weight: bold; margin-bottom: 5px;">üìù Additional Notes:</div>
                                <div style="color: #333; font-style: italic; line-height: 1.6;">${req.additional_notes}</div>
                            </div>
                        ` : ''}
                    </div>

                    ${req.part_images && req.part_images.length > 0 ? `
                        <div class="info-group" style="margin-bottom: 10px; background: #e3f2fd;">
                            <div class="info-label">üì∏ Part Images Uploaded</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                ${req.part_images.map(img => `
                                    <a href="/uploads/${img}" target="_blank">
                                        <img src="/uploads/${img}" alt="Part Image" style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #2196f3; cursor: pointer;">
                                    </a>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- QUOTE CALCULATOR -->
                    <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); border: 3px solid #2e7d32; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        <div style="font-weight: bold; color: white; margin-bottom: 15px; font-size: 1.3em;">
                            üí∞ QUOTE CALCULATOR
                        </div>

                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                            <div style="color: #2e7d32; font-weight: bold; margin-bottom: 10px; font-size: 0.95em;">
                                Formula: Part Price (includes tax) + 30% Warranty + $3 Yard Entry + Labor + Travel + Delivery
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                                <!-- Part Price -->
                                <div>
                                    <label style="display: block; font-size: 0.85em; color: #666; font-weight: 600; margin-bottom: 5px;">Part Price (with tax) ($)</label>
                                    <input type="number" id="calc_part_price_${req.id}" step="0.01" min="0" value="0"
                                           style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                                </div>

                                <!-- Yard Entry (Fixed) -->
                                <div>
                                    <label style="display: block; font-size: 0.85em; color: #666; font-weight: 600; margin-bottom: 5px;">Yard Entry ($)</label>
                                    <input type="number" id="calc_yard_entry_${req.id}" value="3" readonly
                                           style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em; background: #f5f5f5; cursor: not-allowed;">
                                </div>

                                <!-- Labor Fee -->
                                <div>
                                    <label style="display: block; font-size: 0.85em; color: #666; font-weight: 600; margin-bottom: 5px;">Labor Fee ($)</label>
                                    <select id="calc_labor_${req.id}" onchange="calculateQuote(${req.id})"
                                            style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                                        <option value="25">$25</option>
                                        <option value="30">$30</option>
                                        <option value="35">$35</option>
                                        <option value="40">$40</option>
                                        <option value="45">$45</option>
                                        <option value="50">$50</option>
                                        <option value="55">$55</option>
                                        <option value="60">$60</option>
                                        <option value="65">$65</option>
                                        <option value="70">$70</option>
                                        <option value="75">$75</option>
                                        <option value="80">$80</option>
                                        <option value="85">$85</option>
                                        <option value="90">$90</option>
                                        <option value="95">$95</option>
                                        <option value="100">$100</option>
                                    </select>
                                </div>

                                <!-- Travel Fee -->
                                <div>
                                    <label style="display: block; font-size: 0.85em; color: #666; font-weight: 600; margin-bottom: 5px;">Travel Fee ($)</label>
                                    <select id="calc_travel_${req.id}" onchange="calculateQuote(${req.id})"
                                            style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                                        <option value="10">$10</option>
                                        <option value="15">$15</option>
                                        <option value="20">$20</option>
                                    </select>
                                </div>

                                <!-- Delivery Miles -->
                                <div>
                                    <label style="display: block; font-size: 0.85em; color: #666; font-weight: 600; margin-bottom: 5px;">Delivery (Miles @ $2/mi)</label>
                                    <input type="number" id="calc_delivery_${req.id}" step="0.1" min="0" value="0" placeholder="0 = Pickup"
                                           oninput="calculateQuote(${req.id})"
                                           style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                                </div>

                                <!-- Warranty -->
                                <div>
                                    <label style="display: block; font-size: 0.85em; color: #666; font-weight: 600; margin-bottom: 5px;">90-Day Warranty (30% of Part)</label>
                                    <select id="calc_warranty_${req.id}"
                                            style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1em;">
                                        <option value="0">No ($0)</option>
                                        <option value="30percent" ${req.warranty ? 'selected' : ''}>Yes - 30% (90 days)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Calculate Button -->
                            <div style="margin-top: 15px; text-align: center;">
                                <button onclick="calculateQuote(${req.id})"
                                        style="padding: 15px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1em; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                                    üßÆ Calculate Quote
                                </button>
                                ${req.junkyard_parts && req.junkyard_parts !== '[]' && req.junkyard_parts !== '' ? `
                                    <button onclick="autoFillFromJunkyardParts(${req.id}, '${req.junkyard_parts.replace(/'/g, "\\'")}')"
                                            style="margin-left: 10px; padding: 15px 30px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                        üìã Auto-Fill from Junkyard Parts
                                    </button>
                                ` : ''}
                            </div>

                            <!-- Calculation Breakdown -->
                            <div id="calc_breakdown_${req.id}" style="margin-top: 20px; padding: 15px; background: #f0f4ff; border-radius: 8px; border-left: 4px solid #2196f3; display: none;">
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; color: #333; font-size: 0.95em;">
                                    <div>Part Price (with tax):</div><div style="font-weight: bold;">$<span id="calc_display_part_${req.id}">0.00</span></div>
                                    <div>Warranty (30% - 90 days):</div><div style="font-weight: bold;">$<span id="calc_display_warranty_${req.id}">0.00</span></div>
                                    <div>Yard Entry:</div><div style="font-weight: bold;">$<span id="calc_display_yard_${req.id}">3.00</span></div>
                                    <div>Labor:</div><div style="font-weight: bold;">$<span id="calc_display_labor_${req.id}">25.00</span></div>
                                    <div>Travel:</div><div style="font-weight: bold;">$<span id="calc_display_travel_${req.id}">10.00</span></div>
                                    <div>Delivery:</div><div style="font-weight: bold;">$<span id="calc_display_delivery_${req.id}">0.00</span></div>
                                    <div style="border-top: 2px solid #2196f3; padding-top: 10px; font-size: 1.2em; color: #1565c0; font-weight: bold;">TOTAL QUOTE:</div>
                                    <div style="border-top: 2px solid #2196f3; padding-top: 10px; font-size: 1.2em; color: #1565c0; font-weight: bold;">$<span id="calc_total_${req.id}">38.00</span></div>
                                </div>
                            </div>

                            <!-- Generated Message -->
                            <div id="calc_message_${req.id}" style="margin-top: 20px; padding: 20px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                                    <div style="font-weight: bold; color: #2e7d32; font-size: 1.1em;">üì± Copy & Send to Customer</div>
                                    <div style="display: flex; gap: 10px;">
                                        <button id="translate_btn_${req.id}" onclick="toggleLanguage(${req.id})"
                                                style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                            üåê Translate to Spanish
                                        </button>
                                        <button onclick="copyMessage(${req.id})"
                                                style="padding: 8px 16px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                            üìã Copy Message
                                        </button>
                                    </div>
                                </div>
                                <div id="message_text_${req.id}" style="background: white; padding: 15px; border-radius: 6px; font-size: 0.95em; line-height: 1.6; color: #333; white-space: pre-wrap; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                                    <!-- Message will be generated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    ${req.quote_amount > 0 ? `
                        <div class="info-group" style="margin-bottom: 10px; background: #e3f2fd; border-left: 4px solid #2196f3;">
                            <div class="info-label">Quote Details</div>
                            <div class="info-value">Amount: $${req.quote_amount}</div>
                            <div class="info-value">Deposit: $${req.deposit_amount}</div>
                            ${req.quote_message ? `<div class="info-value" style="margin-top: 10px;">${req.quote_message}</div>` : ''}
                        </div>
                    ` : ''}

                    <div class="actions">
                        ${req.status !== 'completed' ? `
                            <button class="btn btn-quote" onclick="openQuoteModal(${req.id})">
                                ${req.quote_amount > 0 ? 'üìù Update Quote' : 'üí∞ Send Quote'}
                            </button>
                            <button class="btn btn-complete" onclick="markAsComplete(${req.id})">
                                ‚úÖ Mark Complete
                            </button>
                        ` : ''}
                        <button class="btn btn-delete" onclick="deleteRequest(${req.id})">
                            üóëÔ∏è Delete
                        </button>
                        <div style="flex: 1;"></div>
                        <div style="padding: 10px; color: #666; font-size: 0.9em;">
                            Language: ${req.language === 'en' ? 'üá∫üá∏ English' : 'üá≤üáΩ Espa√±ol'}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getLaborFee() {
            const select = document.getElementById('labor_fee_select');
            return parseFloat(select.value) || 0;
        }

        function getTravelFee() {
            const select = document.getElementById('travel_fee_select');
            return parseFloat(select.value) || 0;
        }

        function getDeliveryFee() {
            const miles = parseFloat(document.getElementById('delivery_miles').value) || 0;
            return miles * 2; // $2 per mile
        }

        function getWarrantyFee() {
            const select = document.getElementById('warranty_fee_select');
            const partPrice = parseFloat(document.getElementById('part_price').value) || 0;

            if (select.value === '30percent') {
                // Calculate 30% of PART PRICE ONLY
                return partPrice * 0.30;
            }
            return 0;
        }

        // Junkyard part search functionality
        let searchTimeout;
        async function searchJunkyardPart() {
            clearTimeout(searchTimeout);
            const query = document.getElementById('part_search').value.trim();

            if (query.length < 2) {
                document.getElementById('part_search_results').style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/search_junkyard_parts?q=${encodeURIComponent(query)}`);
                    const data = await response.json();

                    if (data.success && data.parts.length > 0) {
                        const resultsHtml = data.parts.map(part => `
                            <div onclick="selectJunkyardPart('${part.name}', ${part.price})" style="padding: 12px; cursor: pointer; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;" onmouseover="this.style.background='#f0f4ff'" onmouseout="this.style.background='white'">
                                <div style="font-weight: bold; color: #333;">${part.name}</div>
                                <div style="color: #667eea; font-size: 0.9em;">$${part.price.toFixed(2)}</div>
                            </div>
                        `).join('');

                        document.getElementById('part_search_results').innerHTML = resultsHtml;
                        document.getElementById('part_search_results').style.display = 'block';
                    } else {
                        document.getElementById('part_search_results').innerHTML = '<div style="padding: 12px; color: #999;">No parts found</div>';
                        document.getElementById('part_search_results').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error searching parts:', error);
                }
            }, 300);
        }

        function selectJunkyardPart(partName, basePrice) {
            // Set the part name in search
            document.getElementById('part_search').value = partName;

            // Calculate tax and add to base price
            const tax = basePrice * 0.0975; // 9.75% tax
            const totalWithTax = basePrice + tax;

            // Set the part price (includes tax)
            document.getElementById('part_price').value = totalWithTax.toFixed(2);

            // Hide search results
            document.getElementById('part_search_results').style.display = 'none';

            // Recalculate total
            calculateTotal();
        }

        function handleLaborFeeChange() {
            calculateTotal();
        }

        function handleTravelFeeChange() {
            calculateTotal();
        }

        function handleWarrantyFeeChange() {
            calculateTotal();
        }

        function calculateTotal() {
            const partPrice = parseFloat(document.getElementById('part_price').value) || 0;
            const yardEntry = parseFloat(document.getElementById('yard_entry').value) || 0;
            const laborFee = getLaborFee();
            const travelFee = getTravelFee();
            const deliveryFee = getDeliveryFee();
            const warrantyFee = getWarrantyFee();

            // Update delivery fee display
            const miles = parseFloat(document.getElementById('delivery_miles').value) || 0;
            document.getElementById('delivery_fee_display').textContent = deliveryFee.toFixed(2);
            document.getElementById('delivery_miles_display').textContent = miles.toFixed(1);

            // Update warranty fee display
            if (warrantyFee > 0) {
                document.getElementById('warranty_fee_display').textContent = `Warranty Fee: $${warrantyFee.toFixed(2)} (30% of Part Price with tax: $${partPrice.toFixed(2)}) - 90 days from junkyard purchase`;
            } else {
                document.getElementById('warranty_fee_display').textContent = '';
            }

            const total = partPrice + yardEntry + laborFee + travelFee + deliveryFee + warrantyFee;
            document.getElementById('quote_amount').value = total.toFixed(2);
        }

        function openQuoteModal(requestId) {
            currentRequestId = requestId;
            const request = allRequests.find(r => r.id === requestId);

            // Show if customer selected warranty
            document.getElementById('warranty_selected').textContent = request.warranty ? 'Yes ‚úÖ' : 'No';
            document.getElementById('warranty_selected').style.color = request.warranty ? '#28a745' : '#dc3545';

            // Pre-fill if updating
            if (request.quote_amount > 0) {
                document.getElementById('quote_amount').value = request.quote_amount;
                document.getElementById('deposit_amount').value = request.deposit_amount;
                document.getElementById('quote_message').value = request.quote_message || '';
            } else {
                // Reset search and part price fields
                document.getElementById('part_search').value = '';
                document.getElementById('part_search_results').style.display = 'none';
                document.getElementById('part_price').value = 0;
                document.getElementById('part_price_breakdown').style.display = 'none';
                document.getElementById('yard_entry').value = 3;

                // Reset dropdowns to default values
                document.getElementById('labor_fee_select').value = '25';
                document.getElementById('travel_fee_select').value = '10';

                // Reset delivery miles
                document.getElementById('delivery_miles').value = 0;

                // Set warranty based on customer selection
                document.getElementById('warranty_fee_select').value = request.warranty ? '30percent' : '0';

                document.getElementById('deposit_amount').value = '';
                document.getElementById('quote_message').value = '';
                calculateTotal();
            }

            document.getElementById('quoteModal').classList.add('active');
        }

        function closeQuoteModal() {
            document.getElementById('quoteModal').classList.remove('active');
            currentRequestId = null;
        }

        async function submitQuote() {
            if (!currentRequestId) return;

            const quoteData = {
                quote_amount: parseFloat(document.getElementById('quote_amount').value),
                deposit_amount: parseFloat(document.getElementById('deposit_amount').value),
                quote_message: document.getElementById('quote_message').value,
                status: 'quoted'
            };

            try {
                const response = await fetch(`/admin/request/${currentRequestId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quoteData)
                });

                const data = await response.json();

                if (data.success) {
                    alert('Quote sent successfully!');
                    closeQuoteModal();
                    loadRequests();
                } else {
                    alert('Error sending quote: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending quote');
            }
        }

        async function markAsComplete(requestId) {
            if (!confirm('Mark this request as completed?')) return;

            try {
                const response = await fetch(`/admin/request/${requestId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'completed' })
                });

                const data = await response.json();

                if (data.success) {
                    alert('Request marked as completed!');
                    loadRequests();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating request');
            }
        }

        async function deleteRequest(requestId) {
            if (!confirm('Are you sure you want to delete this request? This cannot be undone.')) return;

            try {
                const response = await fetch(`/admin/request/${requestId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Request deleted successfully!');
                    loadRequests();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting request');
            }
        }

        // Close modal when clicking outside
        document.getElementById('quoteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeQuoteModal();
            }
        });

        // ==================== INLINE QUOTE CALCULATOR ====================

        function calculateQuote(requestId) {
            const partPrice = parseFloat(document.getElementById(`calc_part_price_${requestId}`).value) || 0;
            const yardEntry = parseFloat(document.getElementById(`calc_yard_entry_${requestId}`).value) || 0;
            const laborFee = parseFloat(document.getElementById(`calc_labor_${requestId}`).value) || 0;
            const travelFee = parseFloat(document.getElementById(`calc_travel_${requestId}`).value) || 0;
            const deliveryMiles = parseFloat(document.getElementById(`calc_delivery_${requestId}`).value) || 0;
            const warrantySelect = document.getElementById(`calc_warranty_${requestId}`).value;

            // Calculate warranty (30% of part price which already includes tax)
            const warrantyFee = warrantySelect === '30percent' ? (partPrice * 0.30) : 0;

            // Calculate delivery fee
            const deliveryFee = deliveryMiles * 2; // $2 per mile

            // Calculate total
            const total = partPrice + warrantyFee + yardEntry + laborFee + travelFee + deliveryFee;

            // Update display
            document.getElementById(`calc_display_part_${requestId}`).textContent = partPrice.toFixed(2);
            document.getElementById(`calc_display_warranty_${requestId}`).textContent = warrantyFee.toFixed(2);
            document.getElementById(`calc_display_yard_${requestId}`).textContent = yardEntry.toFixed(2);
            document.getElementById(`calc_display_labor_${requestId}`).textContent = laborFee.toFixed(2);
            document.getElementById(`calc_display_travel_${requestId}`).textContent = travelFee.toFixed(2);
            document.getElementById(`calc_display_delivery_${requestId}`).textContent = deliveryFee.toFixed(2);
            document.getElementById(`calc_total_${requestId}`).textContent = total.toFixed(2);

            // Show breakdown and message sections
            document.getElementById(`calc_breakdown_${requestId}`).style.display = 'block';
            document.getElementById(`calc_message_${requestId}`).style.display = 'block';

            // Generate customer message
            generateCustomerMessage(requestId, {
                partPrice,
                warrantyFee,
                yardEntry,
                laborFee,
                travelFee,
                deliveryFee,
                deliveryMiles,
                total,
                hasWarranty: warrantySelect === '30percent'
            });
        }

        // Store message data for language toggling
        const messageData = {};

        function generateCustomerMessage(requestId, costs) {
            // Find the request data
            const request = allRequests.find(r => r.id === requestId);
            if (!request) return;

            // Store costs and request data for language toggle
            messageData[requestId] = { costs, request, currentLanguage: 'en' };

            // Generate and display English message
            displayMessageInLanguage(requestId, 'en');
        }

        function displayMessageInLanguage(requestId, language) {
            const data = messageData[requestId];
            if (!data) return;

            const { costs, request } = data;
            const firstName = request.customer_name.split(' ')[0];

            let message;

            if (language === 'en') {
                // English message
                let breakdown = `Part Price (with tax): $${costs.partPrice.toFixed(2)}`;
                breakdown += `\nWarranty of Part Price (30% - 90 days): $${costs.warrantyFee.toFixed(2)}`;
                breakdown += `\nYard Entry: $${costs.yardEntry.toFixed(2)}`;
                breakdown += `\nLabor: $${costs.laborFee.toFixed(2)}`;
                breakdown += `\nTravel: $${costs.travelFee.toFixed(2)}`;

                if (costs.deliveryMiles > 0) {
                    breakdown += `\nDelivery (${costs.deliveryMiles} miles): $${costs.deliveryFee.toFixed(2)}`;
                } else {
                    breakdown += `\nDelivery: Pickup Only`;
                }

                message = `Hey ${firstName}! Thanks for reaching out to me. I'll head to the junkyard to search for your ${request.vehicle_year} ${request.vehicle_make} ${request.vehicle_model} ${request.part_needed || 'part'} and send you pictures so you can confirm before purchase.

Here's your quote:

${breakdown}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL: $${costs.total.toFixed(2)}

${costs.hasWarranty ? '‚úÖ Includes 90-day warranty beginning from day of purchase at the junkyard\n' : ''}Let me know if you'd like to move forward!`;

            } else {
                // Spanish message
                let breakdown = `Precio de Pieza (con impuesto): $${costs.partPrice.toFixed(2)}`;
                breakdown += `\nGarant√≠a del Precio de Pieza (30% - 90 d√≠as): $${costs.warrantyFee.toFixed(2)}`;
                breakdown += `\nEntrada al Yonke: $${costs.yardEntry.toFixed(2)}`;
                breakdown += `\nMano de Obra: $${costs.laborFee.toFixed(2)}`;
                breakdown += `\nViaje: $${costs.travelFee.toFixed(2)}`;

                if (costs.deliveryMiles > 0) {
                    breakdown += `\nEntrega (${costs.deliveryMiles} millas): $${costs.deliveryFee.toFixed(2)}`;
                } else {
                    breakdown += `\nEntrega: Solo Recoger`;
                }

                message = `¬°Hola ${firstName}! Gracias por contactarme. Ir√© al yonke a buscar tu pieza de ${request.vehicle_year} ${request.vehicle_make} ${request.vehicle_model} ${request.part_needed || 'pieza'} y te enviar√© fotos para que confirmes antes de comprar.

Aqu√≠ est√° tu cotizaci√≥n:

${breakdown}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL: $${costs.total.toFixed(2)}

${costs.hasWarranty ? '‚úÖ Incluye garant√≠a de 90 d√≠as desde el d√≠a de compra en el yonke\n' : ''}¬°D√©jame saber si quieres continuar!`;
            }

            // Set the message text
            document.getElementById(`message_text_${requestId}`).textContent = message;
        }

        function toggleLanguage(requestId) {
            const data = messageData[requestId];
            if (!data) return;

            // Toggle language
            data.currentLanguage = data.currentLanguage === 'en' ? 'es' : 'en';

            // Update message
            displayMessageInLanguage(requestId, data.currentLanguage);

            // Update button text
            const btn = document.getElementById(`translate_btn_${requestId}`);
            if (data.currentLanguage === 'es') {
                btn.textContent = 'üåê Translate to English';
                btn.style.background = '#ff9800';
            } else {
                btn.textContent = 'üåê Translate to Spanish';
                btn.style.background = '#2196f3';
            }
        }

        function copyMessage(requestId) {
            const messageText = document.getElementById(`message_text_${requestId}`).textContent;

            // Copy to clipboard
            navigator.clipboard.writeText(messageText).then(() => {
                // Show success feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                btn.style.background = '#2e7d32';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#4caf50';
                }, 2000);
            }).catch(err => {
                alert('Failed to copy message. Please copy manually.');
                console.error('Copy failed:', err);
            });
        }

        function autoFillFromJunkyardParts(requestId, junkyardPartsJson) {
            try {
                const parts = JSON.parse(junkyardPartsJson);

                if (Array.isArray(parts) && parts.length > 0) {
                    // Calculate total cost of all junkyard parts
                    const totalCost = parts.reduce((sum, part) => {
                        return sum + (part.price * (part.qty || 1));
                    }, 0);

                    // Add tax (9.75%)
                    const tax = totalCost * 0.0975;
                    const totalWithTax = totalCost + tax;

                    // Set the part price (with tax)
                    document.getElementById(`calc_part_price_${requestId}`).value = totalWithTax.toFixed(2);

                    // Recalculate
                    calculateQuote(requestId);

                    alert(`Auto-filled with ${parts.length} junkyard part(s).\nSubtotal: $${totalCost.toFixed(2)}\nTax (9.75%): $${tax.toFixed(2)}\nTotal: $${totalWithTax.toFixed(2)}`);
                } else {
                    alert('No junkyard parts found to auto-fill.');
                }
            } catch (e) {
                console.error('Error parsing junkyard parts:', e);
                alert('Error loading junkyard parts data.');
            }
        }

        // Delete all requests
        async function deleteAllRequests() {
            const confirmation = confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL customer requests!\n\nAre you absolutely sure?');

            if (!confirmation) {
                return;
            }

            // Double confirmation
            const doubleCheck = confirm('üö® FINAL WARNING: This cannot be undone!\n\nDelete all requests?');

            if (!doubleCheck) {
                return;
            }

            try {
                const response = await fetch('/admin/delete_all', {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert(`‚úÖ Successfully deleted ${data.deleted_count} request(s)`);
                    loadRequests(); // Reload the page data
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Failed to delete requests');
            }
        }
    </script>
</body>
</html>
